<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura Gold - Digital Vault</title>
    <link rel="icon" href="https://placehold.co/32x32/d4af37/000?text=A&font=inter" type="image/png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js for 3D background -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Chart.js for dashboard charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <!-- Leaflet.js for Live Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhOIN+flILfsO1qkNmrNAcE6DanyM/sCWfF3w=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-react@latest/dist/lucide-react.js"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        
        /* Light Mode Theme - High Visibility Update */
        :root {
            --bg-color: #f3f4f6;
            --text-color: #020617; /* Very dark text for high contrast */
            --text-color-muted: #475569; /* Darker slate for muted text */
            --panel-bg: rgba(255, 255, 255, 0.95); /* High opacity to block background noise */
            --panel-border: rgba(0, 0, 0, 0.15); /* Crisper borders */
            --input-bg: #ffffff;
            --input-border: #94a3b8; /* Visible input borders */
            --hover-bg: #e2e8f0;
            --gold-color: #ca8a04; /* Deeper gold/amber for readability on white */
            --gold-hover: #a16207;
            --shadow-soft: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Dark Mode Theme */
        .dark {
            --bg-color: #000000;
            --text-color: #f9fafb;
            --text-color-muted: #9ca3af;
            --panel-bg: rgba(10, 10, 10, 0.6);
            --panel-border: rgba(255, 255, 255, 0.1);
            --input-bg: #1f2937;
            --input-border: #4b5563;
            --hover-bg: #1f2937;
            --gold-color: #d4af37;
            --gold-hover: #f0c44d;
            --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        /* Applying theme variables */
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--panel-border);
            color: var(--text-color);
            box-shadow: var(--shadow-soft);
        }
        .themed-input {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-color);
        }
        .themed-input:focus {
            --tw-ring-color: var(--gold-color);
            border-color: var(--gold-color);
            outline: 2px solid var(--gold-color);
            outline-offset: -1px;
        }
        .themed-text {
            color: var(--text-color);
        }
        .themed-text-muted {
            color: var(--text-color-muted);
        }
        .themed-border {
            border-color: var(--input-border);
        }
        .themed-hover-bg:hover {
            background-color: var(--hover-bg);
        }
        .gold-text {
            color: var(--gold-color);
        }
        .gold-bg {
            background-color: var(--gold-color);
            color: #fff;
        }
        .dark .gold-bg {
            color: #000;
        }
        .gold-bg:hover {
            background-color: var(--gold-hover);
        }
        .gold-bg:disabled {
            background-color: #a18a4a;
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--input-border);
        }
        .btn-secondary:hover {
            background-color: var(--hover-bg);
            border-color: var(--gold-color);
        }
        
        .step-circle {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background-color: var(--input-bg);
            border: 2px solid var(--input-border);
            color: var(--text-color-muted);
            transition: all 0.3s ease;
            z-index: 10;
        }
        .step-circle.active {
            background-color: var(--gold-color);
            border-color: var(--gold-color);
            color: #fff;
        }
        .dark .step-circle.active { color: #000; }
        
        .step-circle.completed {
            background-color: var(--gold-color);
            border-color: var(--gold-color);
            color: #fff;
        }
        .dark .step-circle.completed { color: #000; }

        .step-line {
            flex-grow: 1;
            height: 2px;
            background-color: var(--input-border);
            margin: 0 -5px;
            z-index: 0;
        }
        .step-line.active {
            background-color: var(--gold-color);
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.05); border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--gold-color); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--gold-hover); }

        /* Active nav item style */
        .nav-item.active {
            color: var(--gold-color);
            border-bottom: 2px solid var(--gold-color);
        }
        .nav-item {
             border-bottom: 2px solid transparent;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        
        /* Toast notification */
        #toast-notification {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translate(-50%, 150%);
            transition: transform 0.5s ease-in-out;
            z-index: 100;
        }
        #toast-notification.show {
            transform: translate(-50%, 0);
        }

        /* File input style */
        .file-input-wrapper {
            border: 2px dashed var(--input-border);
        }
        .dark .file-input-wrapper {
             background-color: var(--input-bg);
        }
        
        /* Asset card styles */
        .asset-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s;
        }
        .asset-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-color: var(--gold-color);
        }
        .asset-card.selected {
            box-shadow: 0 0 0 2px var(--gold-color);
            transform: translateY(-2px);
            border-color: var(--gold-color);
            background-color: rgba(212, 175, 55, 0.05);
        }

        /* Leaflet Map style */
        #leaflet-map, #supplier-map-preview {
            height: 100%;
            width: 100%;
            border-radius: 0.375rem;
            z-index: 1;
        }
        #leaflet-map { height: 500px; }
        .leaflet-control-attribution a { color: #0078A8; }
        .dark .leaflet-control-attribution { color: var(--text-color-muted); }
        .dark .leaflet-tile {
            filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        .market-badge {
            animation: pulse-green 2s infinite;
        }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 5px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
    </style>
</head>
<body class="transition-colors duration-300">

    <!-- 3D Scene Container -->
    <div id="canvas-container"></div>

    <!-- Login Overlay -->
    <div id="login-overlay" class="modal-overlay">
        <div class="glass-panel w-full max-w-sm p-8 rounded-2xl shadow-2xl text-center">
            <h1 class="text-3xl font-bold mb-2"><span class="gold-text">AURA</span> VAULT</h1>
            <p class="themed-text-muted mb-6">Securely log in to your digital vault</p>
            <form id="login-form">
                <input type="email" id="login-email" placeholder="Email" required class="w-full themed-input rounded-lg p-3 mb-4 focus:ring-2 outline-none transition">
                <input type="password" id="login-password" placeholder="Password" required class="w-full themed-input rounded-lg p-3 mb-4 focus:ring-2 outline-none transition">
                <button type="submit" id="login-button" class="w-full gold-bg text-white dark:text-black font-bold py-3 rounded-lg transition-transform hover:scale-105 shadow-md">Login</button>
            </form>
        </div>
    </div>
    
    <!-- Main UI Overlay -->
    <main id="app-container" class="relative w-full h-screen p-4 md:p-8 hidden">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6 md:mb-8">
            <div class="flex flex-col">
                <h1 class="text-xl md:text-2xl font-bold tracking-tight"><span class="gold-text">AURA</span> VAULT</h1>
                <div class="flex items-center gap-2 mt-1">
                    <span class="w-2 h-2 rounded-full bg-green-500 market-badge"></span>
                    <span class="text-xs themed-text-muted">Live Market Data</span>
                </div>
            </div>
            <div class="flex items-center space-x-3 md:space-x-4">
                <!-- Theme Toggle -->
                <button id="theme-toggle-btn" class="p-2 rounded-full glass-panel hover:border-yellow-500 transition-colors">
                    <svg id="theme-icon-sun" class="w-5 h-5 hidden text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    <svg id="theme-icon-moon" class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                </button>
                
                <!-- User Profile -->
                <div class="relative">
                    <button id="user-profile-btn" class="flex items-center space-x-2 p-2 rounded-lg glass-panel hover:bg-white/50 dark:hover:bg-black/50 transition group">
                        <img id="avatar-img" src="https://placehold.co/40x40/334155/d4af37?text=U" class="w-8 h-8 md:w-10 md:h-10 rounded-full border-2 border-transparent group-hover:border-yellow-500 transition">
                        <span id="welcome-message" class="text-sm md:text-base font-medium hidden md:inline">Welcome</span>
                        <!-- Added Chevron Icon for better visibility -->
                        <svg class="w-4 h-4 ml-1 opacity-70 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    
                    <div id="user-profile-dropdown" class="absolute right-0 mt-2 w-48 glass-panel rounded-lg shadow-lg z-50 hidden animate-fade-in">
                        <div class="p-4 border-b themed-border">
                            <p class="font-semibold" id="dropdown-username">User</p>
                            <p class="text-xs themed-text-muted truncate" id="dropdown-email">email@example.com</p>
                        </div>
                        <button onclick="switchView('view-profile')" class="w-full text-left p-3 themed-hover-bg text-sm flex items-center gap-2">
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                             Profile Settings
                        </button>
                        <button id="logout-button" class="w-full text-left p-3 text-red-500 themed-hover-bg text-sm font-medium flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Desktop Navigation -->
        <nav id="desktop-nav" class="hidden md:flex space-x-2 mb-6 pb-2 border-b themed-border">
            <button id="nav-dashboard" onclick="switchView('view-dashboard')" class="nav-item px-4 py-2 font-medium transition-colors active rounded-t-lg hover:bg-gray-100 dark:hover:bg-gray-800">Dashboard</button>
            <button id="nav-transactions" onclick="switchView('view-transactions')" class="nav-item px-4 py-2 font-medium transition-colors rounded-t-lg hover:bg-gray-100 dark:hover:bg-gray-800">Transactions</button>
            <button id="nav-documents" onclick="switchView('view-documents')" class="nav-item px-4 py-2 font-medium transition-colors rounded-t-lg hover:bg-gray-100 dark:hover:bg-gray-800">Documents</button>
            <button id="nav-track" onclick="switchView('view-track')" class="nav-item px-4 py-2 font-medium transition-colors rounded-t-lg hover:bg-gray-100 dark:hover:bg-gray-800">Track</button>
            <button id="nav-audit" onclick="switchView('view-audit')" class="nav-item px-4 py-2 font-medium transition-colors rounded-t-lg hover:bg-gray-100 dark:hover:bg-gray-800">Audit Log</button>
            <button id="nav-profile" onclick="switchView('view-profile')" class="nav-item px-4 py-2 font-medium transition-colors rounded-t-lg hover:bg-gray-100 dark:hover:bg-gray-800">Profile</button>
        </nav>

        <!-- Mobile Navigation Top -->
        <nav id="mobile-menu" class="md:hidden flex overflow-x-auto space-x-1 mb-4 pb-2 border-b themed-border">
            <button id="nav-mobile-dashboard" onclick="switchView('view-dashboard')" class="px-3 py-2 text-sm font-medium gold-text font-bold">Dashboard</button>
            <button id="nav-mobile-transactions" onclick="switchView('view-transactions')" class="px-3 py-2 text-sm font-medium">Transactions</button>
            <button id="nav-mobile-documents" onclick="switchView('view-documents')" class="px-3 py-2 text-sm font-medium">Documents</button>
            <button id="nav-mobile-track" onclick="switchView('view-track')" class="px-3 py-2 text-sm font-medium">Track</button>
            <button id="nav-mobile-audit" onclick="switchView('view-audit')" class="px-3 py-2 text-sm font-medium">Audit</button>
        </nav>

        <!-- Main Content Area -->
        <div class="h-[calc(100vh-180px)] md:h-[calc(100vh-160px)] overflow-y-auto custom-scrollbar">
            
            <!-- Dashboard View -->
            <div id="view-dashboard" class="view animate-fade-in">
                <!-- Stats Summary -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="glass-panel p-4 md:p-6 rounded-lg border-l-4 border-yellow-500">
                        <h3 class="text-sm font-semibold themed-text-muted mb-1 uppercase tracking-wider">Total Value</h3>
                        <p id="dashboard-total-value" class="text-3xl font-bold gold-text">$0.00</p>
                    </div>
                    <div class="glass-panel p-4 md:p-6 rounded-lg border-l-4 border-gray-400">
                        <h3 class="text-sm font-semibold themed-text-muted mb-1 uppercase tracking-wider">Gold Held</h3>
                        <p id="dashboard-gold-held" class="text-3xl font-bold">0.00 g</p>
                    </div>
                    <div class="glass-panel p-4 md:p-6 rounded-lg border-l-4 border-blue-400">
                        <h3 class="text-sm font-semibold themed-text-muted mb-1 uppercase tracking-wider">Asset Count</h3>
                        <p id="dashboard-other-assets" class="text-3xl font-bold">0 Items</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Portfolio Chart -->
                    <div class="glass-panel p-4 md:p-6 rounded-lg">
                        <h3 class="text-xl font-bold mb-4">Portfolio Allocation</h3>
                        <div class="h-64">
                            <canvas id="portfolio-chart"></canvas>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="glass-panel p-4 md:p-6 rounded-lg flex flex-col justify-between">
                        <div>
                            <h3 class="text-xl font-bold mb-4">Quick Actions</h3>
                            <div class="space-y-3">
                                <button onclick="openPurchaseModal()" class="w-full gold-bg font-bold py-3 rounded-lg transition-transform hover:scale-[1.02] shadow-md flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                    Buy New Asset
                                </button>
                                <div class="grid grid-cols-2 gap-3">
                                    <button onclick="switchView('view-transactions')" class="btn-secondary font-bold py-3 rounded-lg transition flex items-center justify-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                                        History
                                    </button>
                                    <button onclick="switchView('view-documents')" class="btn-secondary font-bold py-3 rounded-lg transition flex items-center justify-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                                        Docs
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recent Activity -->
                        <div class="mt-6 pt-6 border-t themed-border">
                            <h4 class="font-semibold mb-3 text-sm uppercase tracking-wide themed-text-muted">Recent Activity</h4>
                            <div id="recent-activity" class="space-y-2 text-sm">
                                <p class="themed-text-muted text-center py-2">No recent activity</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assets Grid -->
                <div class="glass-panel p-4 md:p-6 rounded-lg">
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                        <h3 class="text-xl font-bold mb-4 md:mb-0">Your Assets</h3>
                        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
                            <input type="text" id="asset-search" placeholder="Search assets..." class="themed-input rounded-lg p-2 text-sm w-full md:w-64">
                            <select id="asset-type-filter" class="themed-input rounded-lg p-2 text-sm">
                                <option value="">All Types</option>
                                <option value="Gold">Gold</option>
                                <option value="Silver">Silver</option>
                                <option value="Platinum">Platinum</option>
                                <option value="Diamond">Diamond</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="asset-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Assets will be dynamically inserted here -->
                    </div>
                    
                    <p id="no-assets-message" class="text-center py-8 themed-text-muted">
                        No assets yet. <button onclick="openPurchaseModal()" class="gold-text font-semibold hover:underline">Purchase your first asset</button> to get started.
                    </p>
                </div>
            </div>

            <!-- Other Views -->
            <div id="view-transactions" class="view hidden animate-fade-in">
                <div class="glass-panel p-4 md:p-6 rounded-lg">
                    <h2 class="text-2xl font-bold mb-6">Transactions</h2>
                    <div class="flex border-b themed-border mb-6">
                        <button id="transactions-tab-history" onclick="showTransactionTab('history')" class="tab-btn px-4 py-2 font-medium active">History</button>
                    </div>
                    <div id="transactions-history-tab">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b themed-border text-sm">
                                        <th class="text-left p-4 font-semibold text-gray-500 dark:text-gray-400">Date</th>
                                        <th class="text-left p-4 font-semibold text-gray-500 dark:text-gray-400">Type</th>
                                        <th class="text-left p-4 font-semibold text-gray-500 dark:text-gray-400">Asset</th>
                                        <th class="text-left p-4 font-semibold text-gray-500 dark:text-gray-400">Details</th>
                                        <th class="text-left p-4 font-semibold text-gray-500 dark:text-gray-400">Amount</th>
                                        <th class="text-left p-4 font-semibold text-gray-500 dark:text-gray-400">Status</th>
                                        <th class="text-left p-4 font-semibold text-gray-500 dark:text-gray-400">Receipt</th>
                                    </tr>
                                </thead>
                                <tbody id="transaction-history-body" class="text-sm"></tbody>
                            </table>
                        </div>
                        <p id="no-transactions-message" class="text-center py-8 themed-text-muted hidden">No transactions yet.</p>
                    </div>
                </div>
            </div>

            <div id="view-documents" class="view hidden animate-fade-in">
                <div class="glass-panel p-4 md:p-6 rounded-lg">
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold mb-4 md:mb-0">Documents</h2>
                        <button onclick="openUploadModal()" class="gold-bg font-bold py-2 px-4 rounded-lg shadow-sm">Upload Document</button>
                    </div>
                    <div id="document-list" class="space-y-3"></div>
                    <p id="no-documents-message" class="text-center py-8 themed-text-muted">No documents uploaded yet.</p>
                </div>
            </div>

            <div id="view-track" class="view hidden animate-fade-in">
                <div class="glass-panel p-4 md:p-6 rounded-lg h-full flex flex-col">
                    <div id="shipment-list-view">
                        <h2 class="text-2xl font-bold mb-6">Track Shipments</h2>
                        <div id="shipment-list" class="space-y-3"></div>
                        <p id="no-shipments-message" class="text-center py-8 themed-text-muted">No active shipments.</p>
                    </div>
                    <div id="shipment-detail-view" class="hidden h-full flex flex-col">
                        <div class="flex items-center mb-4">
                            <button onclick="showShipmentList()" class="mr-4 p-2 rounded-lg themed-hover-bg hover:text-yellow-500 transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                            </button>
                            <h2 class="text-2xl font-bold">Shipment Details</h2>
                        </div>
                        <div class="mb-4 flex-grow relative rounded-lg overflow-hidden border themed-border">
                            <div class="absolute top-0 left-0 right-0 p-2 bg-black/50 text-white z-10 text-sm backdrop-blur-sm">
                                <span id="tracking-subheader" class="font-mono"></span>
                            </div>
                            <div id="leaflet-map"></div>
                        </div>
                        <div class="h-1/3 overflow-y-auto">
                            <h3 class="text-lg font-bold mb-4 sticky top-0 glass-panel p-2">Tracking History</h3>
                            <ol id="tracking-status-list" class="relative border-l-2 border-gray-300 ml-3 pb-4"></ol>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-audit" class="view hidden animate-fade-in">
                <div class="glass-panel p-4 md:p-6 rounded-lg">
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold mb-4 md:mb-0">Audit Log</h2>
                        <input type="text" id="audit-search" placeholder="Search logs..." class="themed-input rounded-lg p-2 text-sm w-full md:w-64">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b themed-border text-sm">
                                    <th class="text-left p-4 font-semibold">Timestamp</th>
                                    <th class="text-left p-4 font-semibold">Action</th>
                                    <th class="text-left p-4 font-semibold">Description</th>
                                </tr>
                            </thead>
                            <tbody id="audit-log-body" class="text-sm"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-profile" class="view hidden animate-fade-in">
                <div class="glass-panel p-4 md:p-6 rounded-lg">
                    <h2 class="text-2xl font-bold mb-6">Profile Settings</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-lg font-semibold mb-4">Account Information</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Username</label>
                                    <input type="text" id="profile-username" class="w-full themed-input rounded-lg p-3">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Email</label>
                                    <input type="email" id="profile-email" class="w-full themed-input rounded-lg p-3 bg-gray-100 dark:bg-gray-800" disabled>
                                </div>
                                <button onclick="updateProfile()" class="gold-bg font-bold py-3 px-6 rounded-lg shadow-md">Save Changes</button>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-4">Profile Picture</h3>
                            <div class="flex flex-col items-center space-y-4 p-6 border-2 border-dashed themed-border rounded-lg">
                                <img id="profile-avatar-preview" src="https://placehold.co/128x128/334155/d4af37?text=U" class="w-32 h-32 rounded-full shadow-lg">
                                <div class="text-center">
                                    <input type="file" id="avatar-upload" accept="image/*" class="hidden">
                                    <button onclick="document.getElementById('avatar-upload').click()" class="btn-secondary py-2 px-4 rounded-lg mr-2 text-sm">Upload New</button>
                                    <button onclick="resetAvatar()" class="text-red-500 hover:underline text-sm font-medium">Reset</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 pt-8 border-t themed-border">
                        <h3 class="text-lg font-semibold mb-4">Security</h3>
                        <button onclick="changePassword()" class="bg-red-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-600 transition shadow-md">Change Password</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW Purchase Modal (Multi-step) -->
        <div id="purchase-modal" class="modal-overlay hidden">
            <div class="glass-panel w-full max-w-5xl rounded-2xl shadow-2xl max-h-[90vh] overflow-hidden flex flex-col animate-fade-in border-0">
                <!-- Modal Header -->
                <div class="p-6 border-b themed-border flex justify-between items-center bg-white/10 dark:bg-black/20">
                    <div>
                        <h2 class="text-2xl font-bold">Secure Asset Acquisition</h2>
                        <p class="themed-text-muted text-sm">Expand your portfolio with verified bullion</p>
                    </div>
                    <button onclick="closePurchaseModal()" class="p-2 rounded-full themed-hover-bg transition">âœ•</button>
                </div>
                
                <!-- Stepper -->
                <div class="p-6 pb-2 bg-white/5 dark:bg-black/5">
                    <div class="flex items-center justify-between max-w-3xl mx-auto relative">
                        <div class="flex flex-col items-center cursor-pointer z-10" onclick="goToStep(1)">
                            <div id="step-circle-1" class="step-circle active">1</div>
                            <span class="text-xs mt-2 font-bold tracking-wide">ASSET</span>
                        </div>
                        <div id="step-line-1" class="step-line"></div>
                        <div class="flex flex-col items-center cursor-pointer z-10" onclick="goToStep(2)">
                            <div id="step-circle-2" class="step-circle">2</div>
                            <span class="text-xs mt-2 font-bold tracking-wide">SUPPLIER</span>
                        </div>
                        <div id="step-line-2" class="step-line"></div>
                        <div class="flex flex-col items-center cursor-pointer z-10" onclick="goToStep(3)">
                            <div id="step-circle-3" class="step-circle">3</div>
                            <span class="text-xs mt-2 font-bold tracking-wide">PAYMENT</span>
                        </div>
                        <div id="step-line-3" class="step-line"></div>
                        <div class="flex flex-col items-center cursor-pointer z-10" onclick="goToStep(4)">
                            <div id="step-circle-4" class="step-circle">4</div>
                            <span class="text-xs mt-2 font-bold tracking-wide">CONFIRM</span>
                        </div>
                    </div>
                </div>

                <!-- Modal Body (Scrollable) -->
                <div class="flex-grow overflow-y-auto p-6 custom-scrollbar relative">
                    
                    <!-- STEP 1: ASSET SELECTION -->
                    <div id="step-content-1" class="step-content space-y-8">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6" id="asset-selection-cards">
                            <!-- Cards inserted via JS -->
                        </div>
                        <div class="glass-panel p-8 rounded-xl max-w-2xl mx-auto border-t-4 border-yellow-500 shadow-lg">
                            <h3 class="font-bold mb-6 text-lg">Define Investment</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium mb-2 themed-text-muted">Target Amount (USD)</label>
                                    <div class="relative">
                                        <span class="absolute left-4 top-3 text-gray-500 font-bold">$</span>
                                        <input type="number" id="buy-amount-usd" placeholder="5000.00" class="w-full themed-input rounded-lg p-3 pl-8 text-xl font-mono font-bold">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 themed-text-muted">Equivalent Weight (Grams)</label>
                                    <div class="relative">
                                        <input type="number" id="buy-amount-grams" placeholder="0.00" class="w-full themed-input rounded-lg p-3 text-xl font-mono font-bold bg-gray-5 dark:bg-gray-800">
                                        <span class="absolute right-4 top-3 text-gray-500 font-bold">g</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 2: SUPPLIER SELECTION -->
                    <div id="step-content-2" class="step-content hidden h-full">
                        <div class="flex flex-col md:flex-row h-[450px] gap-6">
                            <!-- Supplier List -->
                            <div class="w-full md:w-1/2 flex flex-col h-full">
                                <div class="mb-4 relative">
                                    <input type="text" id="supplier-search" placeholder="Search verified suppliers..." class="w-full themed-input rounded-lg p-3 pl-10">
                                    <svg class="w-5 h-5 absolute left-3 top-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                </div>
                                <div id="supplier-list" class="space-y-3 overflow-y-auto custom-scrollbar pr-2 flex-grow">
                                    <!-- Suppliers inserted via JS -->
                                </div>
                            </div>
                            <!-- Map Preview -->
                            <div class="hidden md:block w-1/2 glass-panel rounded-xl overflow-hidden relative shadow-inner border themed-border">
                                <div id="supplier-map-preview"></div>
                                <div class="absolute top-4 right-4 glass-panel px-4 py-2 rounded-lg text-sm z-[1000] shadow-md border-l-4 border-yellow-500">
                                    <p class="text-xs themed-text-muted uppercase">Selected Supplier</p>
                                    <p id="map-selected-supplier" class="font-bold text-lg truncate max-w-[200px]">None</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 3: PAYMENT METHOD -->
                    <div id="step-content-3" class="step-content hidden">
                        <div class="max-w-4xl mx-auto">
                            <h3 class="text-xl font-bold mb-6 text-center">Select Payment Method</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                <button onclick="selectPaymentMethod('card')" id="pay-method-card" class="payment-method-btn glass-panel p-6 rounded-xl flex flex-col items-center justify-center gap-3 border-2 border-transparent hover:border-yellow-500 transition-all shadow-sm hover:shadow-md h-40">
                                    <div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                                    </div>
                                    <span class="font-bold">Credit Card</span>
                                    <span class="text-xs themed-text-muted">Instant Processing</span>
                                </button>
                                <button onclick="selectPaymentMethod('bank')" id="pay-method-bank" class="payment-method-btn glass-panel p-6 rounded-xl flex flex-col items-center justify-center gap-3 border-2 border-transparent hover:border-yellow-500 transition-all shadow-sm hover:shadow-md h-40">
                                    <div class="w-12 h-12 rounded-full bg-green-100 text-green-600 flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path></svg>
                                    </div>
                                    <span class="font-bold">Bank Wire</span>
                                    <span class="text-xs themed-text-muted">1-3 Business Days</span>
                                </button>
                                <button onclick="selectPaymentMethod('crypto')" id="pay-method-crypto" class="payment-method-btn glass-panel p-6 rounded-xl flex flex-col items-center justify-center gap-3 border-2 border-transparent hover:border-yellow-500 transition-all shadow-sm hover:shadow-md h-40">
                                    <div class="w-12 h-12 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                    </div>
                                    <span class="font-bold">Bitcoin / Crypto</span>
                                    <span class="text-xs themed-text-muted">Network Confirmation</span>
                                </button>
                            </div>

                            <!-- Payment Forms -->
                            <div id="payment-form-card" class="payment-form hidden glass-panel p-8 rounded-xl shadow-lg border-t-4 border-blue-500">
                                <h3 class="font-bold mb-6 text-lg">Secure Card Payment</h3>
                                <div class="space-y-5">
                                    <div class="relative">
                                        <label class="text-xs font-bold uppercase themed-text-muted">Card Number</label>
                                        <input id="card-number" type="text" placeholder="0000 0000 0000 0000" class="w-full themed-input rounded-lg p-3 font-mono tracking-widest mt-1">
                                        <svg class="w-6 h-6 absolute right-3 bottom-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                                    </div>
                                    <div class="grid grid-cols-2 gap-6">
                                        <div>
                                            <label class="text-xs font-bold uppercase themed-text-muted">Expiry</label>
                                            <input id="card-expiry" type="text" placeholder="MM/YY" class="w-full themed-input rounded-lg p-3 text-center mt-1">
                                        </div>
                                        <div>
                                            <label class="text-xs font-bold uppercase themed-text-muted">CVC</label>
                                            <input id="card-cvc" type="text" placeholder="123" class="w-full themed-input rounded-lg p-3 text-center mt-1">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold uppercase themed-text-muted">Cardholder Name</label>
                                        <input id="card-name" type="text" placeholder="Full Name on Card" class="w-full themed-input rounded-lg p-3 mt-1 uppercase">
                                    </div>
                                </div>
                            </div>
                            
                            <div id="payment-form-bank" class="payment-form hidden glass-panel p-8 rounded-xl shadow-lg border-t-4 border-green-500 text-center">
                                <h3 class="font-bold mb-2 text-lg">Wire Transfer Instructions</h3>
                                <p class="themed-text-muted mb-6 text-sm">Use the reference code below to ensure instant allocation upon receipt.</p>
                                <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-lg font-mono text-sm text-left inline-block shadow-inner border themed-border">
                                    <div class="grid grid-cols-[100px_1fr] gap-2 mb-2">
                                        <span class="themed-text-muted">Bank:</span>
                                        <span class="font-bold">Aura Suisse SA (Zurich)</span>
                                    </div>
                                    <div class="grid grid-cols-[100px_1fr] gap-2 mb-2">
                                        <span class="themed-text-muted">IBAN:</span>
                                        <span class="font-bold">CH93 0000 0000 1234 5678 9</span>
                                    </div>
                                    <div class="grid grid-cols-[100px_1fr] gap-2 mb-2">
                                        <span class="themed-text-muted">SWIFT:</span>
                                        <span class="font-bold">AURA CH ZZ</span>
                                    </div>
                                    <div class="grid grid-cols-[100px_1fr] gap-2 mt-4 pt-4 border-t border-gray-300 dark:border-gray-700">
                                        <span class="themed-text-muted">Ref Code:</span>
                                        <span id="bank-ref-code" class="font-bold text-lg text-blue-600 dark:text-blue-400">GEN-001</span>
                                    </div>
                                </div>
                                <p class="text-xs mt-6 text-orange-500 font-medium flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    Processing time: 1-3 Business Days
                                </p>
                            </div>

                            <div id="payment-form-crypto" class="payment-form hidden glass-panel p-8 rounded-xl shadow-lg border-t-4 border-orange-500 text-center">
                                <h3 class="font-bold mb-2 text-lg">Pay via Bitcoin</h3>
                                <div class="bg-white p-4 inline-block rounded-lg mb-6 shadow-sm">
                                    <img src="https://placehold.co/150x150/000/FFF?text=QR+Code" alt="QR">
                                </div>
                                <div class="mb-4">
                                    <p class="text-xs themed-text-muted mb-1">Send exactly</p>
                                    <p class="text-2xl font-bold font-mono gold-text" id="crypto-amount">0.00 BTC</p>
                                </div>
                                <div class="relative">
                                    <p class="font-mono text-xs break-all bg-gray-100 dark:bg-gray-800 p-3 rounded-lg border themed-border">bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh</p>
                                    <button class="absolute right-2 top-2 p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded" title="Copy">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 4: DELIVERY & SUMMARY -->
                    <div id="step-content-4" class="step-content hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Delivery Options -->
                            <div class="space-y-6">
                                <h3 class="text-xl font-bold">Delivery Method</h3>
                                <div class="space-y-4">
                                    <label class="glass-panel p-5 rounded-xl flex items-start cursor-pointer hover:border-yellow-500 border-2 border-transparent transition shadow-sm relative overflow-hidden group">
                                        <div class="absolute top-0 right-0 p-1 bg-green-500 text-white text-[10px] font-bold rounded-bl">RECOMMENDED</div>
                                        <input type="radio" name="delivery" value="vault" checked onchange="toggleShippingForm()" class="mt-1 mr-4 h-5 w-5 text-yellow-600 focus:ring-yellow-500">
                                        <div>
                                            <span class="font-bold block text-lg mb-1">Secure Vault Storage</span>
                                            <span class="text-sm themed-text-muted block">Free insured storage at Aura Zurich Vault. Instant liquidity when selling back.</span>
                                        </div>
                                    </label>
                                    <label class="glass-panel p-5 rounded-xl flex items-start cursor-pointer hover:border-yellow-500 border-2 border-transparent transition shadow-sm">
                                        <input type="radio" name="delivery" value="shipping" onchange="toggleShippingForm()" class="mt-1 mr-4 h-5 w-5 text-yellow-600 focus:ring-yellow-500">
                                        <div>
                                            <span class="font-bold block text-lg mb-1">Secure Shipping</span>
                                            <span class="text-sm themed-text-muted block">Fully insured armored transport to your verified address.</span>
                                            <span class="inline-block mt-2 px-2 py-0.5 bg-gray-200 dark:bg-gray-700 rounded text-xs font-bold text-gray-700 dark:text-gray-300">+$50.00 Fee</span>
                                        </div>
                                    </label>
                                </div>
                                
                                <div id="shipping-form" class="hidden space-y-4 glass-panel p-6 rounded-xl border-l-4 border-yellow-500 animate-fade-in">
                                    <h4 class="font-bold text-lg mb-2">Shipping Destination</h4>
                                    <input type="text" id="ship-address" placeholder="Street Address" class="w-full themed-input rounded-lg p-3">
                                    <div class="grid grid-cols-2 gap-4">
                                        <input type="text" id="ship-city" placeholder="City" class="themed-input rounded-lg p-3">
                                        <input type="text" id="ship-zip" placeholder="Postal Code" class="themed-input rounded-lg p-3">
                                    </div>
                                    <input type="text" id="ship-country" placeholder="Country" class="w-full themed-input rounded-lg p-3">
                                </div>
                            </div>

                            <!-- Final Summary -->
                            <div class="glass-panel p-8 rounded-xl bg-gradient-to-br from-yellow-50 to-white dark:from-yellow-900/10 dark:to-black border themed-border">
                                <h3 class="text-xl font-bold mb-6 pb-4 border-b themed-border flex justify-between items-center">
                                    Order Summary
                                    <span class="text-xs font-normal px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full">DRAFT</span>
                                </h3>
                                <div class="space-y-4 text-sm">
                                    <div class="flex justify-between items-center">
                                        <span class="themed-text-muted">Asset</span>
                                        <span class="font-bold text-lg" id="summ-item">-</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="themed-text-muted">Supplier</span>
                                        <span class="font-medium text-right" id="summ-supplier">-</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="themed-text-muted">Weight</span>
                                        <span class="font-mono font-bold" id="summ-weight">0.00 g</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="themed-text-muted">Spot Price</span>
                                        <span class="font-mono" id="summ-price">$0.00/g</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="themed-text-muted">Payment</span>
                                        <span class="font-medium px-2 py-1 rounded bg-gray-200 dark:bg-gray-800" id="summ-payment">-</span>
                                    </div>
                                    
                                    <div class="my-6 border-t border-dashed themed-border"></div>
                                    
                                    <div class="flex justify-between items-center">
                                        <span class="themed-text-muted">Subtotal</span>
                                        <span class="font-mono" id="summ-subtotal">$0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="themed-text-muted">Processing Fee (1.5%)</span>
                                        <span class="font-mono text-orange-600 dark:text-orange-400" id="summ-fees">$0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center hidden" id="summ-shipping-row">
                                        <span class="themed-text-muted">Shipping & Insurance</span>
                                        <span class="font-mono">$50.00</span>
                                    </div>
                                    
                                    <div class="flex justify-between items-end mt-6 pt-6 border-t-2 border-yellow-500">
                                        <span class="text-lg font-bold">Total Due</span>
                                        <span class="text-3xl font-bold gold-text font-mono" id="summ-total">$0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Footer Buttons -->
                <div class="p-6 border-t themed-border flex justify-between bg-white/10 dark:bg-black/20 backdrop-blur-md">
                    <button id="btn-prev" onclick="changeStep(-1)" class="btn-secondary px-6 py-3 rounded-lg font-bold hidden flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg> Back
                    </button>
                    <div class="flex-grow"></div>
                    <button id="btn-next" onclick="changeStep(1)" class="gold-bg px-8 py-3 rounded-lg font-bold shadow-lg hover:shadow-yellow-500/20 transition-all flex items-center gap-2">
                        Next Step <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                    <button id="btn-confirm" onclick="confirmPurchase()" class="gold-bg px-8 py-3 rounded-lg font-bold shadow-lg hover:shadow-yellow-500/20 transition-all hidden">
                        <span id="btn-confirm-text">Confirm & Pay</span>
                        <svg id="btn-confirm-spinner" class="animate-spin ml-2 h-5 w-5 inline hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- NEW Sell/Liquidation Wizard -->
        <div id="sell-modal-wizard" class="modal-overlay hidden">
            <div class="glass-panel w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden flex flex-col animate-fade-in">
                <div class="p-6 border-b themed-border flex justify-between items-center bg-red-50 dark:bg-red-900/10">
                    <div>
                        <h2 class="text-2xl font-bold text-red-700 dark:text-red-400">Liquidation Request</h2>
                        <p class="themed-text-muted text-sm">Sell asset back to Aura Vault</p>
                    </div>
                    <button onclick="closeSellWizard()" class="p-2 rounded-full themed-hover-bg">âœ•</button>
                </div>

                <div class="flex-grow p-6 overflow-y-auto custom-scrollbar">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Asset Summary -->
                        <div>
                            <div class="glass-panel p-6 rounded-xl mb-6">
                                <h3 class="font-bold mb-4 border-b pb-2 themed-border">Asset to Liquidate</h3>
                                <div class="flex items-center gap-4 mb-4">
                                    <img id="liq-asset-img" src="" class="w-20 h-20 rounded-lg object-cover bg-gray-200">
                                    <div>
                                        <h4 id="liq-asset-name" class="font-bold text-lg">Asset Name</h4>
                                        <p id="liq-asset-type" class="text-sm themed-text-muted">Type</p>
                                    </div>
                                </div>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between"><span>Weight:</span> <span id="liq-asset-weight" class="font-mono font-bold">0.00g</span></div>
                                    <div class="flex justify-between"><span>Original Purchase:</span> <span id="liq-asset-orig-val" class="font-mono">$0.00</span></div>
                                </div>
                            </div>
                            
                            <div class="glass-panel p-6 rounded-xl border-l-4 border-red-500 bg-red-50 dark:bg-red-900/10">
                                <h3 class="font-bold mb-2">Live Buy-Back Quote</h3>
                                <p class="text-xs text-red-600 dark:text-red-300 mb-4">Quote valid for 60 seconds based on live spot prices.</p>
                                <div class="flex justify-between items-end">
                                    <span class="text-sm themed-text-muted">Net Payout Amount:</span>
                                    <span id="liq-payout-amount" class="text-3xl font-bold font-mono gold-text">$0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Payout Details -->
                        <div class="space-y-6">
                            <h3 class="text-xl font-bold">Payout Destination</h3>
                            
                            <div class="space-y-4">
                                <label class="glass-panel p-4 rounded-xl flex items-center cursor-pointer hover:border-red-500 border-2 border-transparent transition shadow-sm">
                                    <input type="radio" name="payout_method" value="bank" checked onchange="togglePayoutForm()" class="mr-3 h-5 w-5 text-red-600 focus:ring-red-500">
                                    <div class="w-full">
                                        <span class="font-bold block">Bank Wire Transfer</span>
                                        <span class="text-sm themed-text-muted">Funds sent to your registered account (1-3 days).</span>
                                    </div>
                                </label>
                                <label class="glass-panel p-4 rounded-xl flex items-center cursor-pointer hover:border-red-500 border-2 border-transparent transition shadow-sm">
                                    <input type="radio" name="payout_method" value="crypto" onchange="togglePayoutForm()" class="mr-3 h-5 w-5 text-red-600 focus:ring-red-500">
                                    <div class="w-full">
                                        <span class="font-bold block">Crypto Wallet (USDT/BTC)</span>
                                        <span class="text-sm themed-text-muted">Instant settlement to your wallet address.</span>
                                    </div>
                                </label>
                            </div>

                            <div id="payout-bank-form" class="space-y-3 glass-panel p-4 rounded-lg">
                                <input id="payout-bank-name" type="text" placeholder="Account Holder Name" class="w-full themed-input rounded-lg p-3">
                                <input id="payout-bank-iban" type="text" placeholder="IBAN / Account Number" class="w-full themed-input rounded-lg p-3 font-mono">
                                <input id="payout-bank-swift" type="text" placeholder="SWIFT / BIC" class="w-full themed-input rounded-lg p-3 font-mono uppercase w-1/2">
                            </div>

                            <div id="payout-crypto-form" class="hidden space-y-3 glass-panel p-4 rounded-lg">
                                <select class="w-full themed-input rounded-lg p-3">
                                    <option>Bitcoin (BTC)</option>
                                    <option>Ethereum (ETH)</option>
                                    <option>Tether (USDT - ERC20)</option>
                                </select>
                                <input id="payout-crypto-addr" type="text" placeholder="Wallet Address" class="w-full themed-input rounded-lg p-3 font-mono text-sm">
                            </div>
                            
                            <div class="mt-4 pt-4 border-t themed-border">
                                <label class="flex items-start gap-2 cursor-pointer">
                                    <input type="checkbox" id="liq-confirm-check" class="mt-1">
                                    <span class="text-sm themed-text-muted">I authorize the sale of this asset and confirm the payout details are correct. This action is irreversible.</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-6 border-t themed-border bg-gray-50 dark:bg-black/20 flex justify-end gap-3">
                    <button onclick="closeSellWizard()" class="btn-secondary px-6 py-3 rounded-lg font-bold">Cancel</button>
                    <button onclick="confirmLiquidation()" id="btn-confirm-liq" class="bg-red-600 text-white px-8 py-3 rounded-lg font-bold shadow-lg hover:bg-red-700 transition">Confirm Liquidation</button>
                </div>
            </div>
        </div>

        <!-- Improved Asset Detail Modal -->
        <div id="asset-detail-modal" class="modal-overlay hidden">
            <div class="glass-panel w-full max-w-3xl p-0 rounded-2xl shadow-2xl max-h-[90vh] overflow-y-auto animate-fade-in">
                <div class="relative h-64">
                    <img id="detail-asset-image" src="" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                    <button onclick="closeAssetDetailModal()" class="absolute top-4 right-4 bg-black/50 text-white p-2 rounded-full hover:bg-black/80 backdrop-blur-sm">âœ•</button>
                    <div class="absolute bottom-6 left-6 text-white">
                        <span id="detail-asset-type" class="px-2 py-1 bg-yellow-500 text-black text-xs font-bold rounded mb-2 inline-block">Type</span>
                        <h2 id="detail-asset-name" class="text-3xl font-bold">Asset Name</h2>
                        <p class="text-sm opacity-80 font-mono mt-1">ID: <span id="detail-asset-id"></span></p>
                    </div>
                </div>
                
                <div class="p-8 grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <div class="flex justify-between items-center p-4 glass-panel rounded-lg border-l-4 border-green-500">
                            <span class="text-sm themed-text-muted font-bold uppercase">Current Value</span>
                            <span id="detail-asset-value" class="text-2xl font-bold gold-text font-mono">$0.00</span>
                        </div>

                        <div class="space-y-3">
                            <h4 class="font-bold border-b pb-2 themed-border">Specifications</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><span class="themed-text-muted">Weight:</span> <span id="detail-asset-weight" class="font-bold ml-1">0.00 g</span></div>
                                <div><span class="themed-text-muted">Purity:</span> <span id="detail-asset-purity" class="font-bold ml-1">99.9%</span></div>
                                <div><span class="themed-text-muted">Origin:</span> <span id="detail-asset-origin" class="font-bold ml-1">Vault</span></div>
                                <div><span class="themed-text-muted">Acquired:</span> <span id="detail-asset-acquired" class="font-bold ml-1">-</span></div>
                            </div>
                        </div>

                        <!-- Performance Mockup -->
                        <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                            <h4 class="font-bold text-sm mb-2 themed-text-muted">Performance (All Time)</h4>
                            <div class="flex items-center gap-2">
                                <span class="text-2xl font-bold text-green-500">+12.4%</span>
                                <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                            </div>
                            <p class="text-xs themed-text-muted mt-1">Based on simulated market data</p>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-bold border-b pb-2 themed-border mb-4">Provenance & Docs</h4>
                        <div id="detail-asset-docs" class="space-y-2 mb-6">
                            <!-- Docs injected here -->
                        </div>
                        
                        <button onclick="initiateLiquidationFromDetail()" class="w-full border-2 border-red-500 text-red-500 font-bold py-3 rounded-lg hover:bg-red-500 hover:text-white transition">
                            Request Liquidation
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Document Modal (Existing) -->
        <div id="upload-document-modal" class="modal-overlay hidden">
            <div class="glass-panel w-full max-w-md p-6 rounded-2xl shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Upload Document</h2>
                    <button onclick="closeUploadModal()" class="p-2 rounded-full themed-hover-bg">âœ•</button>
                </div>
                
                <div class="space-y-4">
                    <div class="file-input-wrapper p-8 rounded-lg text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-white/5 transition" onclick="document.getElementById('document-file').click()">
                        <input type="file" id="document-file" class="hidden" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                        <div class="mb-4">
                            <svg class="w-16 h-16 mx-auto themed-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z"></path>
                            </svg>
                        </div>
                        <p class="mb-2 font-medium">Click to Upload or Drag Files</p>
                        <p class="text-xs themed-text-muted mt-2">PDF, JPG, PNG (Max 10MB)</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">Document Name</label>
                        <input type="text" id="document-name" placeholder="Enter document name" class="w-full themed-input rounded-lg p-3">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">Link to Asset (Optional)</label>
                        <select id="file-asset-link" class="w-full themed-input rounded-lg p-3">
                            <option value="">None</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-6 flex space-x-3">
                    <button onclick="closeUploadModal()" class="flex-1 btn-secondary py-3 rounded-lg">Cancel</button>
                    <button onclick="uploadDocument()" class="flex-1 gold-bg font-bold py-3 rounded-lg">Upload</button>
                </div>
            </div>
        </div>
    </main>

    <!-- MOBILE NAVIGATION BAR -->
    <nav id="mobile-nav" class="md:hidden fixed bottom-0 left-0 right-0 glass-panel p-2 flex justify-around items-center border-t themed-border z-20 hidden backdrop-blur-md">
        <button id="mobile-nav-dashboard" onclick="switchView('view-dashboard')" class="mobile-nav-item flex flex-col items-center p-2 active">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            <span class="text-xs mt-1">Home</span>
        </button>
        <button id="mobile-nav-transactions" onclick="switchView('view-transactions')" class="mobile-nav-item flex flex-col items-center p-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span class="text-xs mt-1">History</span>
        </button>
        <button id="mobile-nav-track" onclick="switchView('view-track')" class="mobile-nav-item flex flex-col items-center p-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            <span class="text-xs mt-1">Track</span>
        </button>
    </nav>

    <!-- Toast Notification -->
    <div id="toast-notification" class="text-white font-bold py-3 px-6 rounded-lg shadow-lg">
        <p id="toast-message">Notification</p>
    </div>

    <script>
        // jsPDF initialization
        const jsPDF = window.jspdf ? window.jspdf.jsPDF : null;
        
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDT7XhZj_cikP3quWFQ3Tgcjqkyvr6VuWY",
            authDomain: "aura-gold-vault-372ad.firebaseapp.com",
            projectId: "aura-gold-vault-372ad",
            storageBucket: "aura-gold-vault-372ad.firebasestorage.app",
            messagingSenderId: "598585125860",
            appId: "1:598585125860:web:099086d9025fb0bf75b5f1",
            measurementId: "G-LSG76W3XLC"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // --- GLOBAL STATE ---
        let currentUser = null;
        let portfolio = { assets: [], transactions: [], documents: [], shipments: [] };
        let auditLog = [];
        let portfolioChartInstance = null;
        let assetToSell = null;
        let currentPricePerGram = 0;
        
        let purchaseState = {
            step: 1,
            assetType: null,
            grams: 0,
            usd: 0,
            supplier: null,
            paymentMethod: null,
            deliveryType: 'vault'
        };
        
        const suppliers = [
            { id: 1, name: "Istanbul Gold Refinery", location: "Istanbul, Turkey", lat: 41.0082, lng: 28.9784, premium: 0.01 },
            { id: 2, name: "Swiss Bullion Vaults", location: "Zurich, Switzerland", lat: 47.3769, lng: 8.5417, premium: 0.02 },
            { id: 3, name: "Perth Mint Distributor", location: "Perth, Australia", lat: -31.9505, lng: 115.8605, premium: 0.015 },
            { id: 4, name: "Royal Canadian Mint", location: "Ottawa, Canada", lat: 45.4215, lng: -75.6972, premium: 0.018 },
            { id: 5, name: "Dubai Multi Commodities", location: "Dubai, UAE", lat: 25.2048, lng: 55.2708, premium: 0.012 },
            { id: 6, name: "New York Precious Metals", location: "New York, USA", lat: 40.7128, lng: -74.0060, premium: 0.025 }
        ];

        // Updated Asset Types with placeholders for LIVE data
        const assetTypes = [
            { name: 'Gold', code: 'XAU', color: 'bg-yellow-500', apiId: 'pax-gold', basePrice: 0 }, 
            { name: 'Silver', code: 'XAG', color: 'bg-gray-400', apiId: 'kinesis-silver', basePrice: 0 }, 
            { name: 'Platinum', code: 'XPT', color: 'bg-gray-200', apiId: 'platinum-bar', basePrice: 0 },
            { name: 'Diamond', code: 'DIA', color: 'bg-blue-300', apiId: null, basePrice: 5000.00 } 
        ];

        let leafletMap = null;
        let previewMap = null;

        // --- 3D SCENE SETUP ---
        function init3D() {
            try {
                const container = document.getElementById('canvas-container');
                if (!container) return;
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.z = 5;
                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                container.appendChild(renderer.domElement);
                
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);
                const pointLight = new THREE.PointLight(0xffffff, 1.2);
                pointLight.position.set(5, 5, 5);
                scene.add(pointLight);
                
                // Interactive Ring (TorusKnot)
                const geometry = new THREE.TorusKnotGeometry(1.5, 0.3, 100, 16); 
                const material = new THREE.MeshStandardMaterial({
                    color: 0xd4af37, 
                    metalness: 1.0, 
                    roughness: 0.2
                });
                const goldObject = new THREE.Mesh(geometry, material);
                scene.add(goldObject);

                // Mouse Interaction Logic
                let mouseX = 0;
                let mouseY = 0;
                let targetRotationX = 0;
                let targetRotationY = 0;
                
                const windowHalfX = window.innerWidth / 2;
                const windowHalfY = window.innerHeight / 2;

                document.addEventListener('mousemove', (event) => {
                    mouseX = (event.clientX - windowHalfX);
                    mouseY = (event.clientY - windowHalfY);
                });
                
                function animate() {
                    requestAnimationFrame(animate);
                    
                    targetRotationY = mouseX * 0.001;
                    targetRotationX = mouseY * 0.001;

                    // Smooth interpolation towards mouse position
                    goldObject.rotation.y += 0.05 * (targetRotationY - goldObject.rotation.y);
                    goldObject.rotation.x += 0.05 * (targetRotationX - goldObject.rotation.x);
                    
                    // Add a slight constant spin so it's never static
                    goldObject.rotation.z += 0.002;

                    renderer.render(scene, camera);
                }
                animate();
                
                window.addEventListener('resize', () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                });
            } catch (e) { console.warn("3D scene initialization failed", e); }
        }

        // --- REAL TIME DATA FETCHING ---
        async function fetchLivePrices() {
            try {
                // IDs for CoinGecko API: pax-gold = Gold, kinesis-silver = Silver
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=pax-gold,kinesis-silver,platinum-bar&vs_currencies=usd');
                const data = await response.json();
                
                // 1 Troy Ounce = 31.1035 Grams
                const gramsPerOz = 31.1035;

                // Update Gold
                if (data['pax-gold']) {
                    const goldItem = assetTypes.find(a => a.name === 'Gold');
                    if (goldItem) goldItem.basePrice = data['pax-gold'].usd / gramsPerOz;
                }

                // Update Silver
                if (data['kinesis-silver']) {
                    const silverItem = assetTypes.find(a => a.name === 'Silver');
                    if (silverItem) silverItem.basePrice = data['kinesis-silver'].usd / gramsPerOz;
                }
                
                // Fallback / Update Platinum
                const platItem = assetTypes.find(a => a.name === 'Platinum');
                if (platItem && data['platinum-bar']) {
                     platItem.basePrice = data['platinum-bar'].usd / gramsPerOz;
                } else if (platItem && platItem.basePrice === 0) {
                     platItem.basePrice = 32.50; // Fallback
                }

                if (!document.getElementById('purchase-modal').classList.contains('hidden')) {
                    renderAssetSelection();
                }
                
                console.log("Live prices updated");
            } catch (error) {
                console.error("Failed to fetch live prices:", error);
                showToast("Using cached market data", true);
            }
        }

        // --- HELPER FUNCTIONS ---
        const showToast = (message, isError = false) => {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.className = `text-white font-bold py-3 px-6 rounded-lg shadow-lg ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        };

        const logAction = (action, description) => {
            // Optimistic UI update for immediate feedback
            const timestamp = new Date().toLocaleString('en-US');
            
            // Write to database if user is logged in
            if (currentUser) {
                db.collection('audit_logs').add({
                    userId: currentUser.uid,
                    action: action,
                    description: description,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(e => console.error("Audit log failed:", e));
            }
        };

        const switchView = (viewId) => {
            document.querySelectorAll('[id^="view-"]').forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            
            // Hide Dropdown if open
            document.getElementById('user-profile-dropdown').classList.add('hidden');

            document.querySelectorAll('#mobile-menu button').forEach(item => item.className = 'px-3 py-2 text-sm font-medium');
            const mobileTopNav = document.getElementById(`nav-mobile-${viewId.split('-')[1]}`);
            if (mobileTopNav) mobileTopNav.className = 'px-3 py-2 text-sm font-medium gold-text font-bold';

            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            const desktopNav = document.getElementById(`nav-${viewId.replace('view-', '')}`);
            if (desktopNav) desktopNav.classList.add('active');

            if (viewId === 'view-dashboard') renderDashboard();
            if (viewId === 'view-transactions') renderTransactions();
            if (viewId === 'view-documents') renderDocuments();
            if (viewId === 'view-track') renderShipmentList();
        };

        // --- PURCHASE WIZARD ---
        function openPurchaseModal() {
            purchaseState = { step: 1, assetType: null, grams: 0, usd: 0, supplier: null, paymentMethod: null, deliveryType: 'vault' };
            renderAssetSelection();
            renderSupplierList();
            goToStep(1);
            document.getElementById('purchase-modal').classList.remove('hidden');
        }

        function closePurchaseModal() {
            document.getElementById('purchase-modal').classList.add('hidden');
        }

        function goToStep(step) {
            if (step > purchaseState.step) {
                if (purchaseState.step === 1 && (!purchaseState.assetType || purchaseState.grams <= 0)) return showToast("Select asset & amount", true);
                if (purchaseState.step === 2 && !purchaseState.supplier) return showToast("Select a supplier", true);
                if (purchaseState.step === 3) {
                    if (!purchaseState.paymentMethod) return showToast("Select payment method", true);
                    if (purchaseState.paymentMethod === 'card') {
                        const num = document.getElementById('card-number').value;
                        const exp = document.getElementById('card-expiry').value;
                        const cvc = document.getElementById('card-cvc').value;
                        const name = document.getElementById('card-name').value;
                        if (!num || !exp || !cvc || !name) return showToast("Please enter all card details", true);
                    }
                }
            }
            purchaseState.step = step;
            
            for(let i=1; i<=4; i++) {
                const circle = document.getElementById(`step-circle-${i}`);
                const line = document.getElementById(`step-line-${i-1}`);
                const content = document.getElementById(`step-content-${i}`);
                
                circle.classList.remove('active', 'completed');
                if (i === step) circle.classList.add('active');
                if (i < step) circle.classList.add('completed');
                
                if (line) {
                    line.classList.remove('active');
                    if (i <= step) line.classList.add('active');
                }
                content.classList.add('hidden');
                if (i === step) {
                    content.classList.remove('hidden');
                    if (i === 2 && previewMap) setTimeout(() => previewMap.invalidateSize(), 200);
                }
            }
            
            document.getElementById('btn-prev').classList.toggle('hidden', step === 1);
            document.getElementById('btn-next').classList.toggle('hidden', step === 4);
            document.getElementById('btn-confirm').classList.toggle('hidden', step !== 4);
            if (step === 4) updateFinalSummary();
        }

        function changeStep(dir) { goToStep(purchaseState.step + dir); }

        function renderAssetSelection() {
            const container = document.getElementById('asset-selection-cards');
            container.innerHTML = '';
            assetTypes.forEach(asset => {
                const el = document.createElement('div');
                el.className = `asset-card glass-panel p-6 rounded-xl cursor-pointer flex flex-col items-center justify-center text-center border-2 border-transparent transition-all ${purchaseState.assetType === asset.name ? 'selected bg-yellow-50 dark:bg-yellow-900/10 border-yellow-500' : ''}`;
                
                const priceDisplay = asset.basePrice > 0 
                    ? `$${asset.basePrice.toFixed(2)}/g` 
                    : `<span class="animate-pulse text-xs">Fetching Live...</span>`;

                el.onclick = () => selectAsset(asset.name, asset.basePrice, el);
                el.innerHTML = `
                    <div class="w-16 h-16 rounded-full ${asset.color} flex items-center justify-center mb-4 shadow-inner">
                        <span class="text-white font-bold text-lg text-shadow">${asset.code}</span>
                    </div>
                    <h4 class="font-bold text-lg">${asset.name}</h4>
                    <p class="text-sm themed-text-muted mt-1 font-mono">${priceDisplay}</p>
                `;
                container.appendChild(el);
            });
            document.getElementById('buy-amount-usd').oninput = (e) => calculateConversion('usd', e.target.value);
            document.getElementById('buy-amount-grams').oninput = (e) => calculateConversion('grams', e.target.value);
        }

        function selectAsset(type, price, el) {
            if (price === 0) {
                showToast("Waiting for live price update...", true);
                return;
            }
            purchaseState.assetType = type;
            currentPricePerGram = price;
            document.querySelectorAll('#asset-selection-cards > div').forEach(c => c.classList.remove('selected', 'bg-yellow-50', 'dark:bg-yellow-900/10', 'border-yellow-500'));
            el.classList.add('selected', 'bg-yellow-50', 'dark:bg-yellow-900/10', 'border-yellow-500');
            calculateConversion('usd', document.getElementById('buy-amount-usd').value);
        }

        function calculateConversion(source, value) {
            if (!currentPricePerGram) return;
            const val = parseFloat(value) || 0;
            if (source === 'usd') {
                purchaseState.usd = val;
                purchaseState.grams = val / currentPricePerGram;
                document.getElementById('buy-amount-grams').value = purchaseState.grams.toFixed(4);
            } else {
                purchaseState.grams = val;
                purchaseState.usd = val * currentPricePerGram;
                document.getElementById('buy-amount-usd').value = purchaseState.usd.toFixed(2);
            }
        }

        function renderSupplierList() {
            const list = document.getElementById('supplier-list');
            list.innerHTML = '';
            if (!previewMap) {
                previewMap = L.map('supplier-map-preview').setView([20, 0], 2);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(previewMap);
            }
            suppliers.forEach(supplier => {
                const el = document.createElement('div');
                el.className = `glass-panel p-4 rounded-lg cursor-pointer border hover:border-yellow-500 transition-all flex justify-between items-center`;
                el.onclick = () => selectSupplier(supplier, el);
                el.innerHTML = `
                    <div>
                        <h4 class="font-bold text-sm">${supplier.name}</h4>
                        <p class="text-xs themed-text-muted flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path></svg> ${supplier.location}</p>
                    </div>
                    <span class="text-xs bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded font-mono">+${(supplier.premium * 100).toFixed(1)}%</span>
                `;
                list.appendChild(el);
                L.marker([supplier.lat, supplier.lng]).addTo(previewMap).bindPopup(supplier.name);
            });
        }

        function selectSupplier(supplier, el) {
            purchaseState.supplier = supplier;
            document.querySelectorAll('#supplier-list > div').forEach(c => c.classList.remove('border-yellow-500', 'bg-yellow-50', 'dark:bg-yellow-900/10'));
            el.classList.add('border-yellow-500', 'bg-yellow-50', 'dark:bg-yellow-900/10');
            previewMap.flyTo([supplier.lat, supplier.lng], 5);
            document.getElementById('map-selected-supplier').textContent = supplier.name;
        }

        function selectPaymentMethod(method) {
            purchaseState.paymentMethod = method;
            document.querySelectorAll('.payment-method-btn').forEach(b => b.classList.remove('border-yellow-500', 'bg-yellow-50', 'dark:bg-yellow-900/10'));
            document.getElementById(`pay-method-${method}`).classList.add('border-yellow-500', 'bg-yellow-50', 'dark:bg-yellow-900/10');
            document.querySelectorAll('.payment-form').forEach(f => f.classList.add('hidden'));
            document.getElementById(`payment-form-${method}`).classList.remove('hidden');
            if (method === 'bank') document.getElementById('bank-ref-code').innerText = `AUG-${Math.floor(Math.random() * 100000)}`;
            if (method === 'crypto') document.getElementById('crypto-amount').innerText = (purchaseState.usd / 60000).toFixed(6) + " BTC";
        }

        function toggleShippingForm() {
            const val = document.querySelector('input[name="delivery"]:checked').value;
            purchaseState.deliveryType = val;
            const form = document.getElementById('shipping-form');
            if (val === 'shipping') {
                form.classList.remove('hidden');
                document.getElementById('summ-shipping-row').classList.remove('hidden');
            } else {
                form.classList.add('hidden');
                document.getElementById('summ-shipping-row').classList.add('hidden');
            }
            updateFinalSummary();
        }

        function updateFinalSummary() {
            const { usd, grams, assetType, supplier, deliveryType } = purchaseState;
            const fee = usd * 0.015;
            const shipping = deliveryType === 'shipping' ? 50 : 0;
            const total = usd + fee + shipping;
            document.getElementById('summ-item').innerText = assetType;
            document.getElementById('summ-supplier').innerText = supplier ? supplier.name : 'None';
            document.getElementById('summ-weight').innerText = `${grams.toFixed(2)} g`;
            document.getElementById('summ-price').innerText = `$${currentPricePerGram.toFixed(2)}/g`;
            document.getElementById('summ-payment').innerText = purchaseState.paymentMethod ? purchaseState.paymentMethod.toUpperCase() : '-';
            document.getElementById('summ-subtotal').innerText = `$${usd.toFixed(2)}`;
            document.getElementById('summ-fees').innerText = `$${fee.toFixed(2)}`;
            document.getElementById('summ-total').innerText = `$${total.toFixed(2)}`;
        }

        async function confirmPurchase() {
            if (purchaseState.deliveryType === 'shipping') {
                const addr = document.getElementById('ship-address').value;
                const city = document.getElementById('ship-city').value;
                const zip = document.getElementById('ship-zip').value;
                const country = document.getElementById('ship-country').value;
                if (!addr || !city || !zip || !country) return showToast("Please enter complete shipping address", true);
            }

            const btn = document.getElementById('btn-confirm');
            const spinner = document.getElementById('btn-confirm-spinner');
            const btnText = document.getElementById('btn-confirm-text');
            btn.disabled = true;
            btnText.textContent = "Processing...";
            spinner.classList.remove('hidden');
            await new Promise(r => setTimeout(r, 2000));
            try {
                const { usd, grams, assetType, supplier, deliveryType, paymentMethod } = purchaseState;
                const shipping = deliveryType === 'shipping' ? 50 : 0;
                const total = usd + (usd * 0.015) + shipping;
                const assetName = `${grams.toFixed(2)}g ${assetType} (${supplier.name})`;
                
                // Add Asset
                await db.collection('assets').add({
                    userId: currentUser.uid, name: assetName, type: assetType, weight: grams, purity: 99.9,
                    value: usd, supplier: supplier.name, origin_lat: supplier.lat, origin_lng: supplier.lng,
                    date_acquired: firebase.firestore.FieldValue.serverTimestamp(),
                    image_url: `https://placehold.co/300x200/d4af37/000?text=${assetType}`
                });

                // Add Transaction with Explicit Counterparty
                await db.collection('transactions').add({
                    userId: currentUser.uid, 
                    type: 'buy', 
                    asset_name: assetName, 
                    amount: grams, 
                    value: total,
                    payment_method: paymentMethod, 
                    counterparty: supplier.name, // Explicit: Who we bought from
                    supplier: supplier.name, 
                    status: deliveryType === 'shipping' ? 'Processing' : 'In Vault',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                if (deliveryType === 'shipping') {
                    const address = document.getElementById('ship-address').value;
                    const trackingNum = `TRK-${Math.floor(Math.random() * 1000000)}`;
                    await db.collection('shipments').add({
                        userId: currentUser.uid, tracking_number: trackingNum, asset_name: assetName, carrier: "Armored Logistics",
                        origin_lat: supplier.lat, origin_lng: supplier.lng, destination_address: address, status: 'Processing',
                        progress: 0, supplier: supplier.name, status_history: [{ title: 'Order Placed', description: `Order received by ${supplier.name}`, date: new Date().toISOString() }],
                        created_at: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                showToast("Asset purchased successfully!");
                closePurchaseModal();
                logAction('Purchase', `Bought ${assetName} from ${supplier.name}`);
            } catch (err) { showToast(`Error: ${err.message}`, true); } 
            finally { btn.disabled = false; btnText.textContent = "Confirm & Pay"; spinner.classList.add('hidden'); }
        }

        // --- NEW SELL/LIQUIDATION WIZARD FUNCTIONS ---
        function openSellModal(id) {
            const asset = portfolio.assets.find(a => a.id === id);
            if(!asset) return;
            assetToSell = asset;
            
            // Populate Details
            document.getElementById('liq-asset-name').innerText = asset.name;
            document.getElementById('liq-asset-type').innerText = asset.type;
            document.getElementById('liq-asset-weight').innerText = asset.weight.toFixed(2) + "g";
            document.getElementById('liq-asset-orig-val').innerText = "$" + asset.value.toFixed(2);
            document.getElementById('liq-asset-img').src = asset.image_url;
            
            // Real-time calculation for sell price
            const typeInfo = assetTypes.find(t => t.name === asset.type);
            const marketPricePerGram = typeInfo ? typeInfo.basePrice : 0;
            
            let quote = 0;
            if (marketPricePerGram > 0) {
                quote = asset.weight * marketPricePerGram * 0.98; // 2% spread
            } else {
                quote = asset.value * 0.98;
            }

            document.getElementById('liq-payout-amount').innerText = "$" + quote.toFixed(2);
            document.getElementById('liq-payout-amount').dataset.value = quote;

            document.getElementById('sell-modal-wizard').classList.remove('hidden');
        }

        function closeSellWizard() {
            document.getElementById('sell-modal-wizard').classList.add('hidden');
        }

        function togglePayoutForm() {
            const method = document.querySelector('input[name="payout_method"]:checked').value;
            if(method === 'bank') {
                document.getElementById('payout-bank-form').classList.remove('hidden');
                document.getElementById('payout-crypto-form').classList.add('hidden');
            } else {
                document.getElementById('payout-bank-form').classList.add('hidden');
                document.getElementById('payout-crypto-form').classList.remove('hidden');
            }
        }

        async function confirmLiquidation() {
            if(!document.getElementById('liq-confirm-check').checked) return showToast("Please confirm details first", true);
            
            const payoutMethod = document.querySelector('input[name="payout_method"]:checked').value;
            if (payoutMethod === 'bank') {
                const name = document.getElementById('payout-bank-name').value;
                const iban = document.getElementById('payout-bank-iban').value;
                const swift = document.getElementById('payout-bank-swift').value;
                if (!name || !iban || !swift) return showToast("Please enter all bank details", true);
            } else if (payoutMethod === 'crypto') {
                const addr = document.getElementById('payout-crypto-addr').value;
                if (!addr) return showToast("Please enter wallet address", true);
            }

            const quote = parseFloat(document.getElementById('liq-payout-amount').dataset.value);
            const liqRef = `LIQ-${Math.floor(Math.random() * 1000000)}`;
            
            try {
                // Remove asset
                await db.collection('assets').doc(assetToSell.id).delete();
                
                // Add Transaction with Explicit Counterparty
                await db.collection('transactions').add({
                    userId: currentUser.uid, 
                    type: 'sell', 
                    asset_name: assetToSell.name, 
                    amount: assetToSell.weight, 
                    value: quote, 
                    status: 'Liquidated',
                    counterparty: 'Aura Vault', // Explicit: Who we sold to
                    ref_id: liqRef,
                    payment_method: document.querySelector('input[name="payout_method"]:checked').value,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                closeSellWizard();
                showToast("Liquidation request processed!");
                logAction('Liquidation', `Sold ${assetToSell.name} to Aura Vault (Ref: ${liqRef})`);
            } catch(e) { showToast(e.message, true); }
        }

        // --- ASSET DETAILS ---
        function openAssetDetail(id) {
            const asset = portfolio.assets.find(a => a.id === id);
            if(!asset) return;
            assetToSell = asset;
            
            document.getElementById('detail-asset-name').innerText = asset.name;
            document.getElementById('detail-asset-id').innerText = asset.id;
            document.getElementById('detail-asset-type').innerText = asset.type;
            
            const typeInfo = assetTypes.find(t => t.name === asset.type);
            const currentMarketPrice = typeInfo && typeInfo.basePrice > 0 
                ? (asset.weight * typeInfo.basePrice) 
                : asset.value;

            document.getElementById('detail-asset-value').innerText = "$" + currentMarketPrice.toFixed(2);
            document.getElementById('detail-asset-weight').innerText = asset.weight.toFixed(2) + "g";
            document.getElementById('detail-asset-origin').innerText = asset.supplier || "Vault";
            document.getElementById('detail-asset-acquired').innerText = new Date(asset.date_acquired?.toDate()).toLocaleDateString();
            document.getElementById('detail-asset-image').src = asset.image_url;
            
            const docContainer = document.getElementById('detail-asset-docs');
            docContainer.innerHTML = '';
            const docs = portfolio.documents.filter(d => d.assetId === id);
            if(docs.length === 0) docContainer.innerHTML = '<p class="text-sm themed-text-muted">No documents attached.</p>';
            else {
                docs.forEach(doc => {
                    const el = document.createElement('div');
                    el.className = 'glass-panel p-2 rounded flex justify-between items-center text-sm';
                    el.innerHTML = `<span>${doc.name}</span><button class="text-blue-500">View</button>`;
                    docContainer.appendChild(el);
                });
            }
            
            document.getElementById('asset-detail-modal').classList.remove('hidden');
        }

        function closeAssetDetailModal() { document.getElementById('asset-detail-modal').classList.add('hidden'); }
        function initiateLiquidationFromDetail() {
            closeAssetDetailModal();
            openSellModal(assetToSell.id);
        }

        // --- RENDER FUNCTIONS ---
        function renderDashboard() {
            let totalVal = 0, totalGold = 0, count = 0;
            const grid = document.getElementById('asset-grid');
            grid.innerHTML = '';
            
            portfolio.assets.forEach(asset => {
                const typeInfo = assetTypes.find(t => t.name === asset.type);
                const currentVal = (typeInfo && typeInfo.basePrice > 0) 
                    ? (asset.weight * typeInfo.basePrice) 
                    : asset.value;

                totalVal += currentVal;
                if (asset.type === 'Gold') totalGold += asset.weight;
                count++;
                
                const div = document.createElement('div');
                div.innerHTML = `
                <div class="asset-card glass-panel p-5 rounded-xl flex flex-col shadow-sm cursor-pointer" onclick="openAssetDetail('${asset.id}')">
                    <div class="relative h-48 mb-4 overflow-hidden rounded-lg">
                        <img src="${asset.image_url}" class="w-full h-full object-cover transition-transform duration-500 hover:scale-110">
                        <span class="absolute top-2 right-2 bg-black/60 text-white text-xs px-2 py-1 rounded backdrop-blur-sm">${asset.type}</span>
                    </div>
                    <h3 class="text-lg font-bold truncate">${asset.name}</h3>
                    <p class="themed-text-muted text-xs mb-3 flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg> ${asset.supplier || 'Vault'}</p>
                    <div class="mt-auto pt-3 border-t themed-border flex justify-between items-center">
                        <p class="text-xl font-bold gold-text font-mono">$${currentVal.toFixed(2)}</p>
                        <button onclick="event.stopPropagation(); openSellModal('${asset.id}')" class="text-xs font-bold text-red-500 border border-red-200 hover:bg-red-50 dark:hover:bg-red-900/20 px-3 py-1 rounded transition">LIQUIDATE</button>
                    </div>
                </div>`;
                grid.appendChild(div.firstElementChild);
            });
            
            document.getElementById('dashboard-total-value').innerText = `$${totalVal.toFixed(2)}`;
            document.getElementById('dashboard-gold-held').innerText = `${totalGold.toFixed(2)} g`;
            document.getElementById('dashboard-other-assets').innerText = `${count} Items`;
            document.getElementById('no-assets-message').classList.toggle('hidden', count > 0);
            updateChart();
        }

        function updateChart() {
            const ctx = document.getElementById('portfolio-chart').getContext('2d');
            if (portfolioChartInstance) portfolioChartInstance.destroy();
            const dataMap = {};
            portfolio.assets.forEach(a => {
                const typeInfo = assetTypes.find(t => t.name === a.type);
                const val = (typeInfo && typeInfo.basePrice > 0) ? (a.weight * typeInfo.basePrice) : a.value;
                dataMap[a.type] = (dataMap[a.type] || 0) + val;
            });
            portfolioChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dataMap),
                    datasets: [{
                        data: Object.values(dataMap),
                        backgroundColor: ['#d4af37', '#c0c0c0', '#e5e4e2', '#a0d1e3'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });
        }
        
        function renderTransactions() {
            const tbody = document.getElementById('transaction-history-body');
            tbody.innerHTML = '';
            portfolio.transactions.sort((a,b) => b.timestamp - a.timestamp).forEach(tx => {
                const row = document.createElement('tr');
                row.className = 'themed-border border-b hover:bg-black/5 transition';
                const date = tx.timestamp?.toDate ? tx.timestamp.toDate() : new Date();
                const isBuy = tx.type === 'buy';
                
                // Smart Details Logic: Use explicit counterparty if available
                let details = 'N/A';
                if (isBuy) {
                    // Buying FROM a supplier
                    const source = tx.counterparty || tx.supplier || 'Aura Store';
                    details = `
                        <div class="flex flex-col">
                            <span class="font-semibold text-sm">From: ${source}</span>
                            <span class="text-[10px] opacity-75">Paid via ${tx.payment_method ? tx.payment_method.toUpperCase() : 'Card'}</span>
                        </div>`;
                } else {
                    // Selling TO the vault
                    const dest = tx.counterparty || 'Aura Vault';
                    details = `
                        <div class="flex flex-col">
                            <span class="font-semibold text-sm">To: ${dest}</span>
                            <span class="text-[10px] opacity-75">Payout: ${tx.payment_method ? tx.payment_method.toUpperCase() : 'Bank'}</span>
                        </div>`;
                }

                const amountClass = isBuy ? 'text-red-600' : 'text-green-600';
                const sign = isBuy ? '-' : '+';
                const typeBadge = isBuy ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800';

                row.innerHTML = `
                    <td class="p-4 font-mono text-xs">${date.toLocaleDateString()}</td>
                    <td class="p-4"><span class="px-2 py-1 rounded ${typeBadge} text-xs font-bold uppercase">${tx.type}</span></td>
                    <td class="p-4 font-medium">${tx.asset_name}</td>
                    <td class="p-4 text-xs themed-text-muted">${details}</td>
                    <td class="p-4 font-bold font-mono ${amountClass}">${sign}$${tx.value.toFixed(2)}</td>
                    <td class="p-4"><span class="px-2 py-1 rounded bg-gray-100 dark:bg-gray-800 text-xs font-bold">${tx.status}</span></td>
                    <td class="p-4"><button class="text-blue-500 hover:text-blue-700"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></button></td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderShipmentList() {
            const list = document.getElementById('shipment-list');
            list.innerHTML = '';
            portfolio.shipments.forEach(ship => {
                const el = document.createElement('div');
                el.className = 'glass-panel p-5 rounded-lg flex justify-between items-center cursor-pointer hover:border-yellow-500 border border-transparent transition shadow-sm';
                el.onclick = () => showTrackingDetail(ship);
                el.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="bg-blue-100 p-3 rounded-full text-blue-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                        <div>
                            <h4 class="font-bold text-lg">${ship.asset_name}</h4>
                            <p class="text-xs themed-text-muted font-mono">TRK: ${ship.tracking_number}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-bold uppercase tracking-wide">${ship.status}</span>
                        <div class="w-24 h-2 bg-gray-200 rounded-full mt-2 ml-auto overflow-hidden">
                            <div class="h-full bg-blue-500" style="width: ${ship.progress}%"></div>
                        </div>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        function showTrackingDetail(ship) {
            document.getElementById('shipment-list-view').classList.add('hidden');
            document.getElementById('shipment-detail-view').classList.remove('hidden');
            document.getElementById('tracking-subheader').innerText = `Tracking #${ship.tracking_number} via ${ship.carrier}`;
            if (leafletMap) { leafletMap.remove(); leafletMap = null; }
            leafletMap = L.map('leaflet-map');
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(leafletMap);
            const origin = [ship.origin_lat || 41.0082, ship.origin_lng || 28.9784];
            const dest = [origin[0] + 5, origin[1] - 5]; 
            L.marker(origin).addTo(leafletMap).bindPopup(`Origin: ${ship.supplier}`).openPopup();
            L.marker(dest).addTo(leafletMap).bindPopup("Destination");
            const polyline = L.polyline([origin, dest], {color: '#d4af37', weight: 4}).addTo(leafletMap);
            leafletMap.fitBounds(polyline.getBounds());
            // History render
            const historyList = document.getElementById('tracking-status-list');
            historyList.innerHTML = '';
            (ship.status_history || []).forEach(h => {
                const item = document.createElement('li');
                item.className = 'mb-6 ml-6';
                item.innerHTML = `
                    <span class="absolute flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full -left-3 ring-8 ring-white dark:ring-gray-900">
                        <svg class="w-3 h-3 text-blue-800" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                    </span>
                    <h3 class="flex items-center mb-1 text-lg font-semibold text-gray-900 dark:text-white">${h.title}</h3>
                    <time class="block mb-2 text-sm font-normal leading-none text-gray-400">${new Date(h.date).toLocaleDateString()}</time>
                    <p class="text-base font-normal text-gray-500 dark:text-gray-400">${h.description}</p>
                `;
                historyList.appendChild(item);
            });
        }
        function showShipmentList() { document.getElementById('shipment-list-view').classList.remove('hidden'); document.getElementById('shipment-detail-view').classList.add('hidden'); }

        function renderDocuments() {
            const list = document.getElementById('document-list');
            if(!list) return;
            list.innerHTML = '';
            const hasDocs = portfolio.documents && portfolio.documents.length > 0;
            document.getElementById('no-documents-message').classList.toggle('hidden', hasDocs);
            if (hasDocs) {
                portfolio.documents.forEach(doc => {
                    const el = document.createElement('div');
                    el.className = 'glass-panel p-4 rounded-lg flex justify-between items-center mb-3';
                    el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="bg-red-100 p-2 rounded text-red-600 dark:bg-red-900/30 dark:text-red-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></div>
                            <div><h4 class="font-bold text-sm">${doc.name}</h4><p class="text-xs themed-text-muted">${doc.date || new Date().toLocaleDateString()}</p></div>
                        </div>
                        <button class="text-blue-500 hover:text-blue-700 text-sm font-bold">View</button>
                    `;
                    list.appendChild(el);
                });
            }
        }

        function renderAuditLog() {
            const tbody = document.getElementById('audit-log-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            auditLog.forEach(l => {
                const tr = document.createElement('tr');
                tr.className = 'themed-border border-b text-sm';
                tr.innerHTML = `<td class="p-4">${l.timestamp}</td><td class="p-4 font-bold">${l.action}</td><td class="p-4 text-gray-500">${l.description}</td>`;
                tbody.appendChild(tr);
            });
        }

        function openUploadModal() {
            document.getElementById('upload-document-modal').classList.remove('hidden');
            const select = document.getElementById('file-asset-link');
            select.innerHTML = '<option value="">None (General Document)</option>';
            portfolio.assets.forEach(a => {
                const opt = document.createElement('option');
                opt.value = a.id;
                opt.text = a.name;
                select.appendChild(opt);
            });
        }

        function closeUploadModal() { document.getElementById('upload-document-modal').classList.add('hidden'); }

        async function uploadDocument() {
            const fileInput = document.getElementById('document-file');
            const nameInput = document.getElementById('document-name');
            if (!fileInput.files.length && !nameInput.value) return showToast("Please select file and enter name", true);
            const doc = { id: 'doc_' + Date.now(), name: nameInput.value || "Uploaded Document", assetId: document.getElementById('file-asset-link').value, date: new Date().toLocaleDateString(), type: 'pdf' };
            portfolio.documents.push(doc);
            if (currentUser) { try { await db.collection('documents').add({ userId: currentUser.uid, ...doc }); } catch(e) { console.error(e); } }
            renderDocuments(); closeUploadModal(); showToast("Document uploaded successfully"); logAction("Document", `Uploaded ${doc.name}`);
        }

        function showTransactionTab(tabName) {
            if (tabName === 'history') document.getElementById('transactions-history-tab').classList.remove('hidden');
        }

        function updateProfile() {
            const newName = document.getElementById('profile-username').value;
            if (currentUser && newName) {
                currentUser.updateProfile({ displayName: newName }).then(() => {
                    showToast("Profile updated");
                    document.getElementById('welcome-message').innerText = `Welcome, ${newName}`;
                });
            }
        }

        function changePassword() {
            const email = currentUser.email;
            if(email) {
                auth.sendPasswordResetEmail(email).then(() => {
                    showToast("Password reset email sent!");
                }).catch(e => showToast(e.message, true));
            }
        }

        function resetAvatar() {
            document.getElementById('profile-avatar-preview').src = "https://placehold.co/128x128/334155/d4af37?text=U";
        }

        // --- AUTH & INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            init3D();
            fetchLivePrices();
            setInterval(fetchLivePrices, 60000);

            // --- USER PROFILE DROPDOWN LOGIC (FIXED) ---
            const profileBtn = document.getElementById('user-profile-btn');
            const profileDropdown = document.getElementById('user-profile-dropdown');

            if (profileBtn && profileDropdown) {
                profileBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent event from bubbling up to document
                    profileDropdown.classList.toggle('hidden');
                });

                // Close dropdown when clicking anywhere else
                document.addEventListener('click', (e) => {
                    if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                        profileDropdown.classList.add('hidden');
                    }
                });
            }

            if(localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
            document.getElementById('theme-toggle-btn').onclick = () => {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            };
            auth.onAuthStateChanged(user => {
                if(user) {
                    currentUser = user;
                    document.getElementById('login-overlay').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    document.getElementById('mobile-nav').classList.remove('hidden');
                    document.getElementById('welcome-message').innerText = `Welcome, ${user.displayName || 'Investor'}`;
                    document.getElementById('dropdown-username').innerText = user.displayName || 'Investor';
                    document.getElementById('dropdown-email').innerText = user.email || '';
                    
                    db.collection('assets').where('userId', '==', user.uid).onSnapshot(snap => { portfolio.assets = snap.docs.map(d => ({id: d.id, ...d.data()})); renderDashboard(); });
                    db.collection('transactions').where('userId', '==', user.uid).onSnapshot(snap => { portfolio.transactions = snap.docs.map(d => ({id: d.id, ...d.data()})); });
                    db.collection('shipments').where('userId', '==', user.uid).onSnapshot(snap => { portfolio.shipments = snap.docs.map(d => ({id: d.id, ...d.data()})); });
                    
                    // --- NEW: Audit Logs Sync ---
                    db.collection('audit_logs').where('userId', '==', user.uid).onSnapshot(snap => {
                        const logs = snap.docs.map(d => {
                            const data = d.data();
                            return {
                                timestamp: data.timestamp ? data.timestamp.toDate().toLocaleString('en-US') : new Date().toLocaleString('en-US'),
                                action: data.action,
                                description: data.description
                            };
                        });
                        // Sort locally to avoid compound query issues
                        auditLog = logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        renderAuditLog();
                    });

                } else {
                    // --- NEW: COMPLETE LOGOUT STATE CLEARING ---
                    document.getElementById('login-overlay').classList.remove('hidden');
                    document.getElementById('app-container').classList.add('hidden');
                    document.getElementById('mobile-nav').classList.add('hidden');
                    
                    // Clear Data
                    portfolio = { assets: [], transactions: [], documents: [], shipments: [] };
                    auditLog = [];
                    currentUser = null;
                    
                    // Reset Views
                    document.getElementById('asset-grid').innerHTML = '';
                    document.getElementById('transaction-history-body').innerHTML = '';
                    document.getElementById('audit-log-body').innerHTML = '';
                }
            });
            document.getElementById('login-form').onsubmit = (e) => { e.preventDefault(); auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value).catch(err => showToast(err.message, true)); };
            
            // --- NEW: ENHANCED LOGOUT HANDLER ---
            document.getElementById('logout-button').onclick = async () => { 
                // Close dropdown
                document.getElementById('user-profile-dropdown').classList.add('hidden');
                
                if(currentUser) {
                    try {
                        // Log logout before signing out
                        await db.collection('audit_logs').add({
                            userId: currentUser.uid,
                            action: 'Logout',
                            description: 'User logged out securely',
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } catch(e) { console.log("Logout log failed", e); }
                }
                
                auth.signOut().then(() => {
                    showToast("Logged out successfully");
                });
            };
        });
    </script>
</body>
</html>